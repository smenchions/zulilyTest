var ZulilyHPViewModel=function(){var n=this;n.loading=ko.observable(!1);n.error=ko.observable();n.user=new User;n.surveyTemplate=new Survey;n.surveyResult=new Survey;n.selectedImageCount=ko.observable(0);n.loading.subscribe(function(t){t&&n.error(null)});n.user.sId.subscribe(function(t){t?($("#captureEmail").modal("hide"),n.surveyResult.sUserId(t),n.loadExistingUserSurvey()):$("#captureEmail").modal("show")});n.load=function(){n.getUser()};n.getUser=function(){var t="/api/user/",i=$.cookie("User");if(!i&&!n.user.email()){$("#captureEmail").modal("show");return}t=n.user.email()?t+"email/"+n.user.email():t+i;$.ajax({url:t,type:"GET",dataType:"json",processData:!1,contentType:"application/json; charset=utf-8"}).success(function(t){n.loading(!1);t?n.user.fromServerModel(t):n.saveUser()}).fail(function(t){n.loading(!1);n.error(t.responseText)})};n.saveUser=function(){n.user.emailValid()!=!1&&$.ajax({url:"/api/user/",type:"PUT",data:JSON.stringify(n.user.toServerModel()),dataType:"json",processData:!1,contentType:"application/json; charset=utf-8"}).success(function(t){t&&n.user.fromServerModel(t)}).fail(function(t){n.loading(!1);n.error(t.responseText)})};n.loadExistingUserSurvey=function(){$.ajax({url:"/api/survey/user/"+n.user.sId(),type:"GET",dataType:"json",processData:!1,contentType:"application/json; charset=utf-8"}).success(function(t){n.loading(!1);t&&(n.surveyResult.fromServerModel(t),n.surveyResult.type("UserResult"),n.loadSurveyTemplate())}).fail(function(t){n.loading(!1);n.error(t.responseText)})};n.loadSurveyTemplate=function(){n.surveyTemplate.fromServerModel({});$.ajax({url:"/api/survey/",type:"POST",data:JSON.stringify(n.surveyResult.toServerModel()),dataType:"json",processData:!1,contentType:"application/json; charset=utf-8"}).success(function(t){n.loading(!1);n.surveyTemplate.fromServerModel(t[0]);$.each(n.surveyResult.images(),function(t,i){$.each(n.surveyTemplate.images(),function(t,r){i.sId()==r.sId()&&(r.selected(!0),n.selectedImageCount(n.selectedImageCount()+1))})});n.selectedImageCount()>0&&$("#success").modal("show")}).fail(function(t){n.loading(!1);n.error(t.responseText)})};n.saveSurvey=function(){$.ajax({url:"/api/survey/",type:"PUT",data:JSON.stringify(n.surveyResult.toServerModel()),dataType:"json",processData:!1,contentType:"application/json; charset=utf-8"}).success(function(t){n.loading(!1);n.surveyResult.fromServerModel(t);n.loadSurveyTemplate()}).fail(function(t){n.loading(!1);n.error(t.responseText)})};n.selectImage=function(t){t.selected(!t.selected());t.selected()?n.selectedImageCount(n.selectedImageCount()+1):n.selectedImageCount(n.selectedImageCount()-1)};n.submitStyle=function(){n.surveyResult.images.removeAll();$.each(n.surveyTemplate.images(),function(t,i){i.selected()&&n.surveyResult.images.push(i)});n.saveSurvey()};n.logout=function(){$.removeCookie("User");n.user.fromServerModel({});n.surveyTemplate.fromServerModel({});n.selectedImageCount(0);$("#captureEmail").modal("show");$.ajax({url:"/api/survey/",type:"DELETE",data:JSON.stringify(n.surveyResult.toServerModel()),dataType:"json",processData:!1,contentType:"application/json; charset=utf-8"}).success(function(){n.loading(!1);n.surveyResult.fromServerModel({})}).fail(function(t){n.loading(!1);n.error(t.responseText)})}};